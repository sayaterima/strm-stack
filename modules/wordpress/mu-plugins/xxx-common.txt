<?php
/*
Plugin Name: XXX Common
Plugin URI: https://slickstack.io/mu-plugins/xxx-common
Description: Lightweight metadata plugin that displays a SlickStack drop-down menu and control panel area along with occasional notices about critical issues.
Version: 0.0.0
Author: SlickStack
Author URI: https://slickstack.io
License: GPLv3
License URI: http://www.gnu.org/licenses/gpl-3.0.html
Prefix: SSCOMM
*/

/** THIS LIGHTWEIGHT PHP SCRIPT HAS NO SQL QUERIES AND UPDATES DIRECTLY VIA SLICKSTACK */
/** IT IS A REQUIRED MU (MUST-USE) PLUGIN FOR SLICKSTACK (DO NOT REMOVE IT) */

/** ********************************************************************************************* */
/** TABLE OF CONTENTS (XXX Common) ************************************************************** */
/** ********************************************************************************************* */

/** this is a brief summary of the different code snippets you will find in this script */
/** each section should be commented so you understand what is being accomplished */

// A. WP Login Messages
// B. WP Admin Notices (Production)
// C. WP Admin Notices (Staging)
// D. WP Admin Notices (Development)
// E. SlickStack Dashboard
// F. Disk Space Warning (WP Admin Notice)
// G. PHP Hacks Warning (WP Admin Notice)
// H. Switch Environment Menu

/** ********************************************************************************************* */
/** A. XXX Common: WP Login Messages ************************************************************ */
/** ********************************************************************************************* */

/** this is a brief login page welcome message that we use to announce important things */
/** most of the time this feature will only be activated in case of emergencies */

// production
if(WP_ENVIRONMENT_TYPE == 'production') {

	function ss_login_message_production() {
		return '<p class="message">Having trouble logging in? Please clear all cookies for this site and then try again (we use secure cookie rules). The default username and password should be the same as your SFTP login credentials, until you change them. &mdash; <em>SlickStack</em></p>';
	}
	
	add_filter('login_message', 'ss_login_message_production');

}

// staging
if(WP_ENVIRONMENT_TYPE == 'staging') {
 
	function ss_login_message_staging() {
		return '<p class="message">Having trouble logging in? Please clear all cookies for this site and then try again (we use secure cookie rules). The default username and password should be the same as your SFTP login credentials, until you change them. &mdash; <em>SlickStack</em></p>';
	}

	add_filter('login_message', 'ss_login_message_staging');
}

// development
if(WP_ENVIRONMENT_TYPE == 'development') {
 
	function ss_login_message_development() {
		return '<p class="message">Having trouble logging in? Please clear all cookies for this site and then try again (we use secure cookie rules). The default username and password should be the same as your SFTP login credentials, until you change them. &mdash; <em>SlickStack</em></p>';
	}

	add_filter('login_message', 'ss_login_message_development');
}

/** ********************************************************************************************* */
/** B. XXX Common: WP Admin Notices (Production) ************************************************ */
/** ********************************************************************************************* */

/** this is a dynamic notice that is force displayed on the WP Admin backend screen */
/** we use this to announce occasional updates and other critical information */

// add_action('admin_notices', 'ss_admin_notice_production_one');

function ss_admin_notice_production_one() {

    $current_user = wp_get_current_user();
    if(current_user_can('manage_options')) { ?>
    
    <div class="notice notice-info">
    <p><strong>Help us reach 10+ reviews on SourceForge</strong></p>
    <p>We hope you are enjoying SlickStack, and the stability and security that it brings to your WordPress website. As a free software project, the only way we grow is by word of mouth. Please consider leaving an honest review on <a href="https://sourceforge.net/software/product/SlickStack/"><strong>SourceForge</strong></a> if you would like our project to continue growing and getter better during 2022... your encouragement and feedback is truly the only thing keeping us going. And thank you, ahead of time!</p>
    
    <p><em>This message will disappear automatically after a few days, thank you. â€” SlickStack</em></p>
    
    </div>
    
    <?php } else { }

}

/** ********************************************************************************************* */
/** C. XXX Common: WP Admin Notices (Staging) *************************************************** */
/** ********************************************************************************************* */

/** this is a dynamic notice that is force displayed on the WP Admin backend screen */
/** we use this to announce occasional updates and other critical information */

add_action('admin_notices', 'ss_admin_notices_staging');

function ss_admin_notices_staging() {
    $current_user = wp_get_current_user();
    $environment = WP_ENVIRONMENT_TYPE;
    if(current_user_can('manage_options') && $environment == 'staging') { ?>
	
	<div class="notice notice-warning">
    <p><strong>Temporary Staging Site Only</strong></p>
	<p>You are now browsing a temporary staging site, created automagically from your live production site. Data is continuously synced every 12 hours and will overwrite existing data (i.e. all staging files/database) unless you <a href="/wp-admin/admin.php?page=slickstack&tab=staging">pause syncing</a>. Please use this staging site to briefly test new plugins, themes, or features, and use the <a href="https://dev.@SITE_DOMAIN_EXCLUDING_WWW">dev site</a> for any long-term redesign projects. Please also note that this staging site shares the <code>/uploads/</code> directory from the production site to save disk space and improve efficiency.
	<p>To avoid potential conflicts or data loss, it is often easier to simply replicate successful "staging" features in production without overwriting things; however, if you do push your staging site live, keep in mind that only the <code>/wp-content/</code> directory and select <a href="/wp-admin/admin.php?page=slickstack&tab=staging#excluded-tables">database tables</a> will be pushed, and nothing else will be transferred (this process will completely overwrite the plugins, themes, and most database tables of your production site). ANY OTHER RANDOM FILES AND FOLDERS WILL BE IGNORED WHEN PUSHING FROM STAGING TO PRODUCTION.</p>
    <p>If you have SSH access, you can run <code>sudo bash /var/www/ss-push-staging</code> from the shell to push this site live, or <a href="/wp-admin/admin.php?page=slickstack&tab=support">ask your agency</a> for assistance.</p>
	<p><em>We will soon have a one-click button to perform this action.</em></p>
    </div>

    <?php } else { }
}

/** ********************************************************************************************* */
/** D. XXX Common: WP Admin Notices (Development) *********************************************** */
/** ********************************************************************************************* */

/** this is a dynamic notice that is force displayed on the WP Admin backend screen */
/** we use this to announce occasional updates and other critical information */

add_action('admin_notices', 'ss_admin_notices_development');

function ss_admin_notices_development() {
    $current_user = wp_get_current_user();
    $environment = WP_ENVIRONMENT_TYPE;
    if(current_user_can('manage_options') && $environment == 'development') { ?>

    <div class="notice notice-warning">
	<p><strong>Standalone Development Site</strong></p>
    <p>This is a standalone dev site hosted on the same server as your production site, that uses its own database called <code>development</code> along with its own files (nothing is shared between this dev site and staging/production). You may use this site for start-from-scratch web design projects without worrying about anything ever being overwritten. If you wish to copy the web design of this dev site to your production site, simply use a free WordPress plugin such as <strong>All In One Migration</strong>, or copy the files over via <a href="/wp-admin/admin.php?page=slickstack&tab=sftp">SFTP</a>, and the database over via <a href="/wp-admin/admin.php?page=slickstack&tab=database">Adminer</a>.</p>
	<p>If you have SSH access, you can also run <code>sudo bash /var/www/ss-push-development</code> from the shell to push this site live, or <a href="/wp-admin/admin.php?page=slickstack&tab=support">ask your agency</a> for assistance.</p>
	<p><em>We will soon have a one-click button to perform this action.</em></p>
    </div>

    <?php } else { }
}

/** ********************************************************************************************* */
/** E. XXX Common: SlickStack Dashboard ********************************************************* */
/** ********************************************************************************************* */

/** this lightweight control panel displays SlickStack settings to admin users only */
/** for ultimate performance none of this data uses MySQL database queries */

// add ss_menu function to admin_menu
function ss_menu() {
        add_menu_page(
            'SlickStack Settings',
            'SlickStack',
            'manage_options',
            'slickstack',
            'ss_menu_content',
			'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KCTxwYXRoIGZpbGw9ImJsYWNrIiBkPSJNMTcuOSw3LjJMMTIuNCAxNy42IDEyLjQgNy45IDguMyA3LjkgMTEuNyAxIDE1LjggMSAxMi44IDcuMiB6IE0xMS43LDguNkw2LjEgMTkgNi4xIDkuMyAyLjEgOS4zIDUuNSAyLjQgOS42IDIuNCA2LjYgOC42IHoiIGZpbGxydWxlPSJldmVub2RkIiBjbGlwcnVsZT0iZXZlbm9kZCI+Cgk8L3BhdGg+Cjwvc3ZnPg==',
			1
        );
}

add_action('admin_menu', 'ss_menu');

// generate slickstack dashboard content
 function ss_menu_content() {
    echo '<div class="wrap">
    <h1>SlickStack Settings</h1>';
    
  //Get the active tab from the $_GET param
  $default_tab = null;
  $tab = isset($_GET['tab']) ? $_GET['tab'] : $default_tab;
  
  ?>
  
    <nav class="nav-tab-wrapper">
      <a href="?page=slickstack" class="nav-tab <?php if($tab===null):?>nav-tab-active<?php endif; ?>">General</a>
      
      <?php if(MULTISITE != 'true'){ ?>
      <a href="?page=slickstack&tab=sftp" class="nav-tab <?php if($tab==='sftp'):?>nav-tab-active<?php endif; ?>">SFTP</a>
      <a href="?page=slickstack&tab=database" class="nav-tab <?php if($tab==='database'):?>nav-tab-active<?php endif; ?>">Database</a>
      <a href="?page=slickstack&tab=error-log" class="nav-tab <?php if($tab==='error-log'):?>nav-tab-active<?php endif; ?>">Error Log</a>
      <a href="?page=slickstack&tab=caching" class="nav-tab <?php if($tab==='caching'):?>nav-tab-active<?php endif; ?>">Caching</a>
	  <a href="?page=slickstack&tab=cloudflare" class="nav-tab <?php if($tab==='cloudflare'):?>nav-tab-active<?php endif; ?>">Cloudflare</a>
	  <a href="?page=slickstack&tab=staging" class="nav-tab <?php if($tab==='staging'):?>nav-tab-active<?php endif; ?>">Staging/Dev</a>
      <?php } ?>
      
      <a href="?page=slickstack&tab=backups" class="nav-tab <?php if($tab==='backups'):?>nav-tab-active<?php endif; ?>">Backups</a>
      <a href="?page=slickstack&tab=billing" class="nav-tab <?php if($tab==='billing'):?>nav-tab-active<?php endif; ?>">Billing</a>
      <a href="?page=slickstack&tab=support" style="float:right;margin-right:0.5em;" class="nav-tab <?php if($tab==='support'):?>nav-tab-active<?php endif; ?>">Get Support</a>
      <a href="?page=slickstack&tab=tools" style="float:right;" class="nav-tab <?php if($tab==='tools'):?>nav-tab-active<?php endif; ?>">Tools</a>
	  
    </nav><!-- nab-tab-wrapper -->

    <div class="tab-content">
	
    <?php switch($tab) :
    
	case 'support':
	
		echo '<br class="clear" />
		<h2>Community Support</h2>
		<p>This website is running on SlickStack, an open source script for optimizing WordPress cloud servers. To learn more about the project, or to get support from our community, please visit the links below:</p>
		<ul class="ul-disc">
		<li>SlickStack homepage: <a href="https://slickstack.io">https://slickstack.io</a></li>
		<li>General FAQ: <a href="https://slickstack.io/faq">https://slickstack.io/faq</a></li>
		<li>Public mirrors: <a href="https://mirrors.slickstack.io">https://mirrors.slickstack.io</a></li>
		<li>Report an issue (bug): <a href="https://github.com/littlebizzy/slickstack/issues/new">https://github.com/littlebizzy/slickstack/issues/new</a></li>
		<li>GitHub repo: <a href="https://github.com/littlebizzy/slickstack">https://github.com/littlebizzy/slickstack</a></li>
		<li>Email newsletter: <a href="https://cdn.forms-content.sg-form.com/6ba39413-e148-11ea-b64b-d22850ff1ee7">https://cdn.forms-content.sg-form.com/6ba39413-e148-11ea-b64b-d22850ff1ee7</a></li>
		<li>Discord server: <a href="https://discord.gg/nGskJdg">https://discord.gg/nGskJdg</a></li>
		<li>Skype group chat: <a href="https://join.skype.com/NdpqKrN2BHdN">https://join.skype.com/NdpqKrN2BHdN</a></li>
		</ul>
		<br class="clear" />
		<h2>@WHITELABEL_BRAND Support</h2>
		<p>The agency that installed this SlickStack cloud server is also available to assist you. Please contact them using the links below:</p>
		<ul class="ul-disc">
		<li>Agency homepage: <a href="@WHITELABEL_HOMEPAGE">@WHITELABEL_HOMEPAGE</a></li>
		<li>Support requests: <a href="@WHITELABEL_SUPPORT_URL">@WHITELABEL_SUPPORT_URL</a></li>
		<li>Support email: <a href="mailto:@WHITELABEL_SUPPORT_EMAIL">@WHITELABEL_SUPPORT_EMAIL</a></li>
		</ul>
		<br class="clear" />';
        
	break;
    
	
	case 'tools':
	
		echo '<br class="clear" />
		<h2>Free Auditing Tools</h2>
		<p>Please use the below tools to test the security and performance of your website:</p>
		
		<div class="card">
		<h2 class="title">HTTP Security Headers</h2>
		<p>You can test your <a href="https://securityheaders.com/?q=https://@SITE_DOMAIN&hide=on&followRedirects=on">HTTP security headers</a> using this tool from Scott Helme.</p>
		</div>
		
		<div class="card">
		<h2 class="title">DNSSEC Analyzer</h2>
		<p>You can test your <a href="https://securityheaders.com/?q=https://@SITE_DOMAIN&hide=on&followRedirects=on">HTTP security headers</a> using this tool from Scott Helme.</p>
		</div>
				
		<ul class="ul-disc">
		<li>Security Headers (By Scott Helme): <a href="https://securityheaders.com/?q=https://@SITE_DOMAIN&hide=on&followRedirects=on">https://securityheaders.com/?q=https://@SITE_DOMAIN&hide=on&followRedirects=on</a></li> 
		<li>GTmetrix (By Carbon60): <a href="https://gtmetrix.com/?url=https://@SITE_DOMAIN&location=2">https://gtmetrix.com/?url=https://@SITE_DOMAIN&location=2</a></li>
		<li>DNSSEC Analyzer (By VeriSign): <a href="https://dnssec-analyzer.verisignlabs.com/@SITE_TLD">https://dnssec-analyzer.verisignlabs.com/@SITE_TLD</a></li>
		<li>PageSpeed Insights (By Google): <a href="https://developers.google.com/speed/pagespeed/insights/?url=https://@SITE_DOMAIN">https://developers.google.com/speed/pagespeed/insights/?url=https://@SITE_DOMAIN</a></li>
		<li>SSL Test (By Qualys SSL Labs): <a href="https://www.ssllabs.com/ssltest/analyze.html?d=https://@SITE_DOMAIN&latest">https://www.ssllabs.com/ssltest/analyze.html?d=https://@SITE_DOMAIN&latest</a></li>
		<li>Mobile-Friendly Test (By Google): <a href="https://search.google.com/test/mobile-friendly?url=https://@SITE_DOMAIN">https://search.google.com/test/mobile-friendly?url=https://@SITE_DOMAIN</a></li>
		<li>Blacklist Spam Check (By MxToolbox): <a href="https://mxtoolbox.com/SuperTool.aspx?action=blacklist%3a@SITE_TLD&run=toolpage">https://mxtoolbox.com/SuperTool.aspx?action=blacklist%3a@SITE_TLD&run=toolpage</a></li>
		<li>IPv6 Ready Test (By  Jamie Finnigan): <a href="https://ready.chair6.net/?url=https://@SITE_DOMAIN">https://ready.chair6.net/?url=https://@SITE_DOMAIN</a></li>
		<li>DNS Lookup (By IntoDNS): <a href="https://intodns.com/@SITE_TLD">https://intodns.com/@SITE_TLD</a></li>
		<li>MX Lookup (By MxToolbox): <a href="https://mxtoolbox.com/SuperTool.aspx?action=mx%3a@SITE_TLD&run=toolpage">https://mxtoolbox.com/SuperTool.aspx?action=mx%3a@SITE_TLD&run=toolpage</a></li>
		<li>DMARC Lookup (By Mimecast): <a href="https://www.dmarcanalyzer.com/dmarc/dmarc-record-check/?dmarcdns%5Btype%5D=dmarc&dmarcdns%5Bdomain%5D=@SITE_TLD">https://www.dmarcanalyzer.com/dmarc/dmarc-record-check/?dmarcdns%5Btype%5D=dmarc&dmarcdns%5Bdomain%5D=@SITE_TLD</a></li>
		<li>Web Security Test (By ImmuniWeb): <a href="https://www.immuniweb.com/websec/?id=@SITE_DOMAIN">https://www.immuniweb.com/websec/?id=@SITE_DOMAIN</a></li>
		<li>VirusTotal Scan (By Chronicle): <a href="https://www.virustotal.com/gui/search/@SITE_DOMAIN">https://www.virustotal.com/gui/search/@SITE_DOMAIN</a></li>
		</ul>';
        
	break;
	
	
	case 'billing':
	
		echo '<br class="clear" />
		<p>Coming soon... easy automatic billing options for web agencies.</p>';
        
	break;
	
	
	case 'backups':
	
		echo '<br class="clear" />
		<h2>Backup Settings</h2>
		<p>Coming soon... powered by Rclone! Choose from Backblaze, Dropbox, Amazon S3, Google Drive, and more...</p>
		<br class="clear" />
		<h3>Recent Local Backups</h3>
		<br class="clear" />';
        
	break;
	
	
	case 'cloudflare':
	
	$cf_api_key = CLOUDFLARE_API_KEY;
	$cf_api_key_masked = substr_replace($cf_api_key, str_repeat('*', strlen($cf_api_key)-4), 0, -4);
		
        echo '<br class="clear" />
		<h2>Cloudflare Settings</h2>
		<p>Cloudflare is a free DNS proxy service from the United States, with the largest and fastest DNS network <a href="https://www.dnsperf.com/" target="_blank" rel="noopener noreferrer">in the world</a>. We highly recommend using Cloudflare in front of your SlickStack cloud server to improve speed, security, and stability. Although most of the default Cloudflare settings are decent, we recommend optimizing <a href="https://slickstack.io/blog/best-cloudflare-settings" target="_blank" rel="noopener noreferrer">certain settings</a> that benefit WordPress websites in particular, esp. SSL settings, cache/minify settings, and a few custom Page Rules.</p>
		<br class="clear" />
		<p><strong>Cloudflare API Key:</strong> <code>' . $cf_api_key_masked . '</code></p>
		<p><strong>Cloudflare API Email:</strong> <code>' . CLOUDFLARE_API_EMAIL . '</code></p>
		<br class="clear" />
		<a class="button" href="https://dash.cloudflare.com/" target="_blank" rel="noopener noreferrer">Launch Cloudflare dashboard</a> <a class="button" href="https://dash.cloudflare.com/profile/api-tokens" target="_blank" rel="noopener noreferrer">Retrieve/generate API keys</a>
		<br class="clear" />
        <p><a href="/wp-admin/options-general.php?page=cloudflare"><strong>Click here for more Cloudflare settings</strong></a></p>';
        	
	break;
	
	
	case 'staging':
	
		echo '<br class="clear" />
		<h2>Staging/Dev Site Settings</h2>
		<p>To activate staging/dev sites, first enable them in <code>ss-config</code> and then point <code>staging.@SITE_DOMAIN_EXCLUDING_WWW</code> and/or <code>dev.@SITE_DOMAIN_EXCLUDING_WWW</code> to the origin IP address <code>' . SYSTEM_IPV4_ADDRESS . '</code> before running <code>ss-install</code> again.</p>
		<ul class="ul-disc">
		<li>Staging Site: <code>' . STAGING_SITE_STATUS . '</code></li>
		<li>Dev Site: <code>' . DEV_SITE_STATUS . '</code></li>
		<li>Last sync (production to staging): <em>coming soon</em></li>
		<li>Last sync (production to development): <em>coming soon</em></li>
		<li>Last push (staging to production): <em>coming soon</em></li>
		<li>Last push (development to production): <em>coming soon</em></li>
		<li>Auto-sync status: <code>' . SYNC_STAGING_SITE_STATUS . '</code> (ask your agency to pause this if desired)</li>
		<li>Auto-sync interval: coming soon</li>
		</ul>
		<br class="clear" />
		<p>The following functions are installed on all SlickStack staging sites: <em>Disable Emails</em>, <em>Disable WP Cron</em>, and <em>Disable Default Runner (WooCommerce Scheduler)</em>.</p>
		<br class="clear" />
		<h3 id="excluded-tables">Excluded Database Tables</h3>
		<p>The following database tables will NOT be synced when pushing from staging to production (COMING SOON):</p>
		<ul class="ul-disc">
		<li><code>wc_download_log</code></li>
		<li><code>wc_product_meta_lookup</code></li>
		<li><code>wc_reserved_stock</code></li>
		<li><code>woocommerce_sessions</code></li>
		<li><code>woocommerce_order_items</code></li>
		<li><code>woocommerce_order_itemmeta</code></li>
		<li><code>woocommerce_payment_tokens</code></li>
		<li><code>woocommerce_payment_tokenmeta</code></li>
		<li><code>woocommerce_log</code></li>
		<li><code>wp_commentmeta</code></li>
		<li><code>wp_comments</code></li>
		<li><code>wp_usermeta</code></li>
		<li><code>wp_users</code></li>
		</ul>';
        
	break;
	
	
    case 'caching':
		
        echo '<br class="clear" />
		<h2>Cache Settings</h2>
		<p><strong>PHP OPcache:</strong> ' . (is_array(opcache_get_status()) ? 'enabled' : 'disabled') . '</p>
		<br class="clear" />
        <p><a href="/wp-admin/options-general.php?page=clear-caches">Click here for Clear Caches settings (same window)</a></p>';
        	
	break;
	
	
	case 'sftp':
	
	if(MULTISITE != 'true'){
	
		$ip_server = $_SERVER['SERVER_ADDR'];

		echo '<br class="clear" />
		<h2>SFTP Details</h2>
		
		<ul>
		<li>Website: <code>' . WP_HOME . '</code></li>
		<li>Server (host): <code>' . $ip_server . '</code></li>
		<li>SFTP user: <code>' . SFTP_USER . '</code></li>
		<li>SFTP password: <code>' . SFTP_PASSWORD . '</code></li>
		<li>SFTP port: <code>' . SFTP_PORT . '</code></li>
		<li>Root Directory: <code>/var/www</code></li>
		<li>Public Directory: <code>/var/www/html</code></li>
		</ul>
		
		<br class="clear" />
		<p><em>You must choose the SFTP protocol when connecting (not FTP or FTPS) on the port number listed above.</em></p>
		<br class="clear" />
		<a class="button" href="#">Reset SFTP Password</a>';
		
	} // end if
        
	break;
	
	
	case 'database':
		
    	echo '<br class="clear" />
		<h2>Database Access</h2>
		<p>You can use the below credentials to login and manage your database using Adminer, even if you are using a remote database server:</p>
		<ul class="ul-disc">
		<li>Database host (and port): <code>' . DB_HOST . '</code></li>
		<li>Database name: <code>' . DB_NAME . '</code></li>
		<li>Database user: <code>' . DB_USER . '</code></li>
		<li>Database password: <code>' . DB_PASSWORD . '</code></li>
		</ul>
		<br class="clear" />
		<a class="button" href="https://@SITE_DOMAIN/adminer?username=' . DB_USER . '&db=' . DB_NAME . '&server=' . DB_HOST . '" target="_blank" rel="noopener noreferrer">Launch Adminer (new window)</a>';
        
	break;
	
	
	case 'error-log':
		
    echo '<br class="clear" />
		<h2>Error Log</h2>
		<p>Below are the most recent (<em>E_ERROR</em>, <em>E_WARNING</em>, <em>E_PARSE</em>) lines from the PHP error log: <code>/var/www/logs/php-error.log</code></p>
		<div style="overflow-x: scroll;"><pre>';

    function lastLines($file, $lines) {
    	$size = filesize($file);
		$fd=fopen($file, 'r+');
		$pos = $size;
		$n=0;
		
        while ( $n < $lines+1 && $pos > 0) {
        fseek($fd, $pos);
        $a = fread($fd, 1);
                if ($a === "\n") {
                        ++$n;
                };
        $pos--;
        }
        // $array = array_reverse($array);                      
        $ret = array();
                for ($i=0; $i<$lines; $i++) {
                array_push($ret, fgets($fd));
                }
				
	$retrev = array_reverse($ret);
	return $retrev;
    }
    
    print_r(implode(lastLines('/var/www/logs/php-error.log', 999)));
    echo '</pre></div> 
    <br class="clear" />
    <form action="#" method="post"><button name="clearlog" class="button">Clear Error Log</button></form>';

	if(isset($_POST['clearlog'])) {
    	$logpath = "/var/www/logs/php-error.log";
    	file_put_contents($logpath, "");
	}

	break;


	default:
		
		$ss_os = PHP_OS_FAMILY;
		
		$ss_cpu = 1;
		if(is_file('/proc/cpuinfo')) {
    		$cpuinfo = file_get_contents('/proc/cpuinfo');
    		preg_match_all('/^processor/m', $cpuinfo, $matches);
    		$ss_cpu = count($matches[0]);
		}
      
        echo '<div class="card" style="max-width:100% !important;">
		<h2 class="title">Welcome to SlickStack</h2>
		<p>SlickStack is an open source LEMP stack script for KVM cloud servers, based on several years of testing and thousands of hours of coding, designed to improve the speed, security, and stability of your WordPress website. Our goal is to simplify and streamline your cloud server configuration, while reducing common "bloat" and evangelizing best practices, to help your team focus more on growth and SEO.</p>
		<p>Because our software stack includes server-level Nginx page cache, Redis object cache, and PHP OPcache, there is no need to install additional WordPress cache plugins or AMP features when using SlickStack. In addition, several security settings are hardcoded into our configuration, such as anti-brute force rate-limiting and blocking of sensitive URLs, therefore bulky security plugins are usually not very helpful either.</p>
		<p><a href="https://github.com/sponsors/jessuppi"><strong>Sponsor our work</strong></a> | <a href="https://github.com/littlebizzy/slickstack/issues">Report a bug/issue</a> | <a href="https://cdn.forms-content.sg-form.com/6ba39413-e148-11ea-b64b-d22850ff1ee7">Email newsletter</a> | <a href="/wp-admin/admin.php?page=slickstack&tab=support">Get support</a></p>
		</div>
		<br class="clear" />
		<p><strong>SlickStack Build:</strong> ' . SS_BUILD . '</p>
		<p><strong>Virtualization Technology:</strong> ' . SYSTEM_VIRTUAL . '</p>
		<p><strong>Linux Kernel:</strong> ' . SYSTEM_LINUX_KERNEL . '</p>
		<p><strong>Operating System:</strong> ' . SYSTEM_OS_PRETTY_NAME . '</p>
		<p><strong>IP Address (IPv4):</strong> ' . SYSTEM_IPV4_ADDRESS . '</p>
		<p><strong>IP Address (IPv6):</strong> ' . SYSTEM_IPV6_ADDRESS . '</p>
		<p><strong>Hostname:</strong> ' . SYSTEM_HOSTNAME . '</p>
		<p><strong>Disk Space:</strong> ' . SYSTEM_DISK_FREE_EASY . ' free space out of ' . SYSTEM_DISK_TOTAL_EASY . ' total space (' . SYSTEM_DISK_USED_PERCENT . ' currently used)</p>
		<p><strong>vCPU Cores:</strong> ' . SYSTEM_CPU_CORES . ' cores</p>
		<p><strong>Nginx Version:</strong> ' . SYSTEM_SERVER_SOFTWARE . '</p>
		<p><strong>PHP Version:</strong> ' . SYSTEM_PHP_VERSION . '</p>
		<p><strong>PHP Extensions:</strong> ' . SYSTEM_PHP_EXTENSIONS . '</p>
		<p><strong>MySQL Version:</strong> ' . SYSTEM_MYSQL_VERSION . '</p>
		<p><strong>MySQL Database(s) Size:</strong> ' . SYSTEM_MYSQL_SIZE . '</p>';
        
		break;
		
    endswitch; ?>
    </div><!-- tab-content -->

    <?php echo '</div><!-- wrap -->';
}

/** ********************************************************************************************* */
/** F. XXX-Common: Disk Space Warning (WP Admin Notice) ***************************************** */
/** ********************************************************************************************* */

/** this hardcoded notice will appear when server disk space is beginning to run out */
/** it will be red if more than 90% used and yellow if more than 80% used */

$disk_used_percent_now = SYSTEM_DISK_USED_PERCENT;
$disk_used_percent_now_cleaner = trim($disk_used_percent_now, '%');

if ((int)$disk_used_percent_now_cleaner >= 90) {
	add_action('admin_notices', 'ss_notices_disk_space_90');
} elseif ((int)$disk_used_percent_now_cleaner >= 80) { 
	add_action('admin_notices', 'ss_notices_disk_space_80');
}

// more than 90% used
function ss_notices_disk_space_90() {
    $current_user = wp_get_current_user();
    if(current_user_can('manage_options')) { ?>

    <div class="notice notice-error">
	<p><strong>Disk Space Warning</strong></p>
    <p>Server disk space is running out with <a href="/wp-admin/admin.php?page=slickstack"><?php 
$disk_used_percent_notice_90 = SYSTEM_DISK_USED_PERCENT;
echo $disk_used_percent_notice_90; ?> currently used</a>; please consider upgrading your server, adding additional block storage to this server, and/or deleting any files and folders that are not required by your website.</p>
	<p><em>This message will disappear after sufficient free space exists, thank you. â€” SlickStack</em></p>
    </div>

    <?php } else { }
}

// more than 80% used
function ss_notices_disk_space_80() {
    $current_user = wp_get_current_user();
    if(current_user_can('manage_options')) { ?>

    <div class="notice notice-warning">
	<p><strong>Disk Space Warning</strong></p>
    <p>Server disk space is running out with <a href="/wp-admin/admin.php?page=slickstack"><a href="/wp-admin/admin.php?page=slickstack"><?php 
$disk_used_percent_notice_80 = SYSTEM_DISK_USED_PERCENT;
echo $disk_used_percent_notice_80; ?> currently used</a>; please consider upgrading your server, adding additional block storage to this server, and/or deleting any files and folders that are not required by your website.</p>
	<p><em>This message will disappear after sufficient free space exists, thank you. â€” SlickStack</em></p>
    </div>

    <?php } else { }
}

/** ********************************************************************************************* */
/** G. XXX-Common: PHP Hacks Warning (WP Admin Notice) ****************************************** */
/** ********************************************************************************************* */

/** SlickStack Admin Notices */
// if plugin or theme files found to be hacking PHP ini or error handling settings

/** ********************************************************************************************* */
/** XXX-Common: SlickStack WP Admin Toolbar Menu (Shortcuts) ************************************ */
/** ********************************************************************************************* */

/** SlickStack Toolbar Shortcuts */
// add_action('admin_bar_menu', 'slickstack_menu', 25);

function slickstack_menu() {
    if(current_user_can('manage_options') ) {
        global $wp_admin_bar;
        $ss_menu = 'slickstack-menu';

		$wp_admin_bar->add_menu( array('parent' => $ss_menu, 'id' => 'ss-menu-reviews', 'title' => 'Review SlickStack',  'href' => false) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-facebook', 'title' => 'Review on Facebook',  'href' => 'https://www.facebook.com/slickstack/reviews', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-producthunt', 'title' => 'Review on Product Hunt',  'href' => 'https://www.producthunt.com/posts/slickstack', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-capterra', 'title' => 'Review on Capterra',  'href' => 'https://www.capterra.com/p/211436/SlickStack/', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-stackshare', 'title' => 'Review on StackShare',  'href' => 'https://stackshare.io/slickstack', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-saashub', 'title' => 'Review on SaaSHub',  'href' => 'https://www.saashub.com/slickstack-alternatives', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-g2-crowd', 'title' => 'Review on G2 Crowd',  'href' => 'https://www.g2.com/products/slickstack/reviews', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-alternativeme', 'title' => 'Review on Alternative.me',  'href' => 'https://alternative.me/slickstack', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-alternativeto', 'title' => 'Review on AlternativeTo',  'href' => 'https://alternativeto.net/software/slickstack', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-wappalyzer', 'title' => 'Review on Wappalyzer',  'href' => 'https://www.wappalyzer.com/technologies/development/slickstack', 'meta' => array('target' => '_blank') ) );
        $wp_admin_bar->add_menu( array('parent' => 'ss-menu-reviews', 'id' => 'ss-menu-reviews-slant', 'title' => 'Review on Slant',  'href' => 'https://www.slant.co/improve/options/35681/~slickstack-review', 'meta' => array('target' => '_blank') ) );
    } else { }
}
    
        // $wp_admin_bar->add_menu(array('parent' => $menu_id, 'title' => __('Client Login'), 'id' => 'slickstack-account', 'href' => 'https://www.littlebizzy.com/account', 'meta' => array('target' => '_blank')));
        // $wp_admin_bar->add_menu(array('parent' => $menu_id, 'title' => __('User Guide'), 'id' => 'slickstack-guide', 'href' => 'https://www.littlebizzy.com/guide', 'meta' => array('target' => '_blank')));

/** ********************************************************************************************* */
/** H. XXX-Common: Switch Environment Menu ****************************************************** */
/** ********************************************************************************************* */

/** this small drop-down menu lets you easily switch between enabled environments */
/** links will be hidden in case certain environments have been disabled */

// add action
add_action('admin_bar_menu', 'ss_environment_menu', 25);

## ss_environment_menu function
function ss_environment_menu($admin_bar) {
    
    $current_user = wp_get_current_user();
    $ss_production_link = '@SITE_DOMAIN';
    $ss_staging_link = 'staging.@SITE_DOMAIN_EXCLUDING_WWW';
    $ss_dev_link = 'dev.@SITE_DOMAIN_EXCLUDING_WWW';
	$actual_link = "https://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
	$actual_link_staging_to_production = str_replace($ss_staging_link, $ss_production_link, $actual_link);
	$actual_link_staging_to_dev = str_replace($ss_staging_link, $ss_dev_link, $actual_link);
	$actual_link_dev_to_production = str_replace($ss_dev_link, $ss_production_link, $actual_link);
	$actual_link_dev_to_staging = str_replace($ss_dev_link, $ss_staging_link, $actual_link);
	$actual_link_production_to_dev = str_replace($ss_production_link, $ss_dev_link, $actual_link);
	$actual_link_production_to_staging = str_replace($ss_production_link, $ss_staging_link, $actual_link);
    
    if(current_user_can('manage_options')) {
	
		// staging site drop-down menu
        if(WP_ENVIRONMENT_TYPE == 'staging') {
		
            // current environment
            $admin_bar->add_menu( array(
                'parent' => 'top-secondary',
                'id'    => 'ss_environment_current',
                'title' => '<span style="color:#FFBA00;">STAGING ONLY</span>',
                'href'  => false
                ) );
				
        // production (required)
        $admin_bar->add_menu( array(
            'parent' => 'ss_environment_current', 
            'id' => 'ss_environment_toggle_production',
            'title' => 'Switch To Production', 
            'href' => $actual_link_staging_to_production, 
            'meta' => array('target' => '_blank')
            ) );
			
        // dev (if enabled)
		if(DEV_SITE_STATUS == 'true') {
        $admin_bar->add_menu( array(
            'parent' => 'ss_environment_current', 
            'id' => 'ss_environment_toggle_dev',
            'title' => 'Switch To Dev', 
            'href' => $actual_link_staging_to_dev, 
            'meta' => array('target' => '_blank')
            ) );
		}
            
        } // end staging site drop-down menu
        
		
		// dev site drop-down menu
        elseif(WP_ENVIRONMENT_TYPE == 'development') {
                
        // current environment
        $admin_bar->add_menu( array(
            'parent' => 'top-secondary',
            'id'    => 'ss_environment_current',
            'title' => '<span style="color:#FFBA00;">DEVELOPMENT</span>',
            'href'  => false
            ) );
            
        // production (required)
        $admin_bar->add_menu( array(
            'parent' => 'ss_environment_current', 
            'id' => 'ss_environment_toggle_production',
            'title' => 'Switch To Production', 
            'href' => $actual_link_dev_to_production, 
            'meta' => array('target' => '_blank')
            ) );
            
        // staging (if enabled)
		if(STAGING_SITE_STATUS == 'true') {
        $admin_bar->add_menu( array(
            'parent' => 'ss_environment_current', 
            'id' => 'ss_environment_toggle_dev',
            'title' => 'Switch To Staging', 
            'href' => $actual_link_dev_to_staging, 
            'meta' => array('target' => '_blank')
            ) );
		}
            
        } // end dev site drop-down menu
        
		
		// production site drop-down menu
        else {
        
        // current environment
        $admin_bar->add_menu( array(
            'parent' => 'top-secondary',
            'id'    => 'ss_environment_current',
            'title' => '<span style="color:#3CB54C;">PRODUCTION</span>',
            'href'  => false
            ) );
            
        // staging (if enabled)
		if(STAGING_SITE_STATUS == 'true') {
        $admin_bar->add_menu( array(
            'parent' => 'ss_environment_current', 
            'id' => 'ss_environment_toggle_staging',
            'title' => 'Switch To Staging', 
            'href' => $actual_link_production_to_staging, 
            'meta' => array('target' => '_blank')
            ) );
		}
            
        // dev (if enabled)
		if(DEV_SITE_STATUS == 'true') {
        $admin_bar->add_menu( array(
            'parent' => 'ss_environment_current', 
            'id' => 'ss_environment_toggle_dev',
            'title' => 'Switch To Dev', 
            'href' => $actual_link_production_to_dev, 
            'meta' => array('target' => '_blank')
            ) );
		}
            
        } // end production site drop-down menu
        
    } else { }
}


/** ********************************************************************************************* */
/** SlickStack: External References Used To Improve This Script (Thanks, Interwebz) ************* */
/** ********************************************************************************************* */

// Ref: https://www.digitalocean.com/community/questions/enable-php-5-5-opcache-on-ubuntu-14-04-with-nginx-and-php-fpm
// Ref: https://stackoverflow.com/questions/15025875/what-is-the-best-way-in-php-to-read-last-lines-from-a-file
// Ref: https://stackoverflow.com/questions/4948663/php-get-bool-to-echo-false-when-false
// Ref: https://core.trac.wordpress.org/ticket/51086
// Ref: https://github.com/stevegrunwell/wp-admin-tabbed-settings-pages
// Ref: https://wordpress.stackexchange.com/questions/84200/how-to-change-default-icon-of-custom-plugin
// Ref: https://wordpress.stackexchange.com/questions/311412/how-can-i-make-my-admin-icon-svg-color-correctly
// Ref: https://stackoverflow.com/questions/30620226/custom-svg-admin-menu-icon-in-wordpress
// Ref: https://developer.wordpress.org/reference/functions/add_menu_page/
// Ref: https://second-cup-of-coffee.com/using-an-svg-icon-for-a-wordpress-custom-post-type/
// Ref: https://stackoverflow.com/questions/53246094/how-do-i-convert-multi-path-svg-to-one-path
// Ref: https://graphicdesign.stackexchange.com/questions/27312/illustrator-make-paths-as-a-compound-path
// Ref: https://graphicdesign.stackexchange.com/questions/71506/how-to-generate-a-single-path-for-a-svg-using-illustrator
// Ref: https://stackoverflow.com/questions/68100124/get-a-single-path-value-for-svg-file-having-multiple-paths
// Ref: https://jsfiddle.net/kirillbelyaev/u88m7fa2/
// Ref: https://gist.github.com/andytlr/9283541
// Ref: https://github.com/palantir/blueprint/issues/2389
// Ref: https://stackoverflow.com/questions/29110399/how-to-edit-the-contents-of-a-file-on-button-click-php
// Ref: https://digwp.com/2016/05/wordpress-admin-notices/
// Ref: https://stackoverflow.com/questions/15001353/remove-characters-from-a-variable
// Ref: https://stackoverflow.com/questions/54865119/php-if-greater-than
// Ref: https://wordpress.stackexchange.com/questions/229228/init-action-and-refresh-page-after-form-action
// Ref: https://wordpress.stackexchange.com/questions/229139/how-to-properly-refresh-page-after-form-action
// Ref: https://stackoverflow.com/questions/21843830/clear-form-after-submit-and-page-refresh-wordpress
// Ref: https://github.com/woocommerce/woocommerce/wiki/Database-Description
// Ref: https://github.com/littlebizzy/slickstack/issues/121
// Ref: https://stackoverflow.com/questions/6768793/get-the-full-url-in-php
// Ref: https://stackoverflow.com/questions/44200823/how-to-mask-parts-of-a-string-with-the-asterisk-character

// SS_EOF
